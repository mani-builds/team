<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/x-icon" href="../../img/logo/neighborhood/favicon.png">
    <title>Configure Your Server - MemberCommons</title>
    <link rel="stylesheet" href="../../css/common.css">
    <link rel="stylesheet" href="../../css/shared-styles.css">
    
    <!-- Standalone Navigation -->
    <link rel="stylesheet" href="../../css/standalone-nav.css">
    <script src="../../js/standalone-nav.js"></script>
    <style>
        .container {
            max-width: 1000px;
            margin: 0 auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="breadcrumb">
            <a href="../">‚Üê Admin Dashboard</a>
        </div>

        <div class="header">
            <h1>
                <div class="gemini-icon">C</div>
                Configure Your Server
                <!-- Google Gemini Insights -->
            </h1>
            <p><a href="../import-data.html">Our Data Import Page</a> let's you send a dataset to Claude and Gemini for analysis when <a href="../">running the site locally</a>. Test and validate your Google Gemini AI API key configuration. This ensures the AI integration is working properly for enhanced SuiteCRM functionality.<br><br>

            We've created a robust page for <a href="../../projects/#list=modelteam">Coding Meetup Integration</a></p>
        </div>

        <div class="card" id="os-detection-panel">
            <h2 class="card-title">Operating System & CLI Tools</h2>
            <div style="display: flex; gap: 32px; margin-bottom: 16px;">
                <div>
                    <select id="os" style="padding: 8px 12px; border: 1px solid var(--border-medium); border-radius: var(--radius-sm); font-size: 14px; min-width: 150px;">
                        <option value="">Select OS...</option>
                        <option value="Mac">Mac</option>
                        <option value="PC">PC</option>
                        <option value="Linux">Linux</option>
                        <option value="Other">Other</option>
                    </select>
                    <div id="os-info" style="color: var(--text-secondary); font-size: 12px; margin-top: 4px;"></div>
                </div>
                <div>
                    <span style="font-weight: 500; margin-right: 12px;">CLI Already Installed:</span>
                    <div style="display: inline-flex; gap: 16px;">
                        <label style="display: flex; align-items: center; gap: 8px; font-size: 14px;">
                            <input type="checkbox" id="claude-code-cli" style="margin: 0;">
                            <span>Claude Code CLI</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; font-size: 14px;">
                            <input type="checkbox" id="gemini-cli" style="margin: 0;">
                            <span>Gemini CLI</span>
                        </label>
                    </div>
                </div>
            </div>
            <div id="cli-commands" style="display: none; margin-top: 16px; padding: 16px; background: var(--bg-tertiary); border-radius: var(--radius-md); border: 1px solid var(--border-light);">
                <div id="cli-instructions" style="margin-bottom: 16px;">
                    Launch a terminal in your "<span id="repo-name">team</span>" repo and run your Command Line Interface (CLI) in a virtual environment.
                </div>
                <div id="claude-code-commands" style="display: none;">
                    <h4 style="margin: 0 0 8px 0; color: var(--text-primary);">Claude Code CLI Installation:</h4>
                    <pre style="background: var(--bg-primary); padding: 12px; border-radius: var(--radius-sm); font-family: monospace; font-size: 13px; line-height: 1.4; margin: 0; overflow-x: auto;"><code>python3 -m venv env
source env/bin/activate
npx @anthropic-ai/claude-code</code></pre>
                </div>
                <div id="gemini-commands" style="display: none;">
                    <h4 style="margin: 16px 0 8px 0; color: var(--text-primary);">Gemini CLI Installation:</h4>
                    <pre style="background: var(--bg-primary); padding: 12px; border-radius: var(--radius-sm); font-family: monospace; font-size: 13px; line-height: 1.4; margin: 0; overflow-x: auto;"><code>python3 -m venv env
source env/bin/activate
npm install -g @google/generative-ai</code></pre>
                </div>
            </div>
        </div>

        <div class="card" id="web-server-panel">
            <h2 class="card-title">
                <span class="status-indicator" id="web-server-status"></span>
                <span id="web-server-title">Local Web Server</span>
            </h2>
            <div id="web-server-content">
                <p style="color: var(--text-secondary);">
                    Checking web server status...
                </p>
            </div>
        </div>

        <div class="card" id="rust-api-panel">
            <h2 class="card-title">
                <span class="status-indicator" id="rust-api-status"></span>
                <span id="rust-api-title">Rust API Inactive</span>
            </h2>
            <div id="rust-api-content">
                <div style="color: var(--accent-yellow); margin-bottom: 16px;">
                    ‚ö†Ô∏è Backend API unavailable - showing .env file data only
                </div>
                <p style="color: var(--text-secondary); margin-bottom: 16px;">
                    The Rust backend server needs to be started to access full configuration and testing capabilities.
                </p>
                <div class="actions">
                    <button class="btn btn-primary" id="start-with-claude">
                        ü§ñ Use Claude (Recommended)
                    </button>
                    <button class="btn btn-secondary" id="start-without-claude">
                        ‚öôÔ∏è Without Claude
                    </button>
                </div>
                <div style="margin-top: 12px; font-size: 12px; color: var(--text-secondary);">
                    Claude option will automatically start the server for you. Manual option shows commands to run yourself.
                </div>
            </div>
        </div>

        <div class="card" id="api-configuration-panel">
            <h2 class="card-title">
                <span class="status-indicator" id="api-status"></span>
                API Configuration Status
            </h2>
            
            <div id="gemini-key-container" style="display: none;"></div>
            
            <div class="config-info" id="config-display">
                Loading configuration...
            </div>

            <div id="test-instruction" style="margin-bottom: 10px;">
                Start the Rust API first. Then you can test the Gemini API.
            </div>

            <div class="actions">
                <button class="btn btn-primary" id="test-gemini" disabled>
                    <span class="loading-spinner" id="test-spinner" style="display: none;"></span>
                    Test Gemini API
                </button>
            </div>

            <div id="test-result"></div>
            
            <div class="actions" style="margin-top: 16px;">
                <button class="btn btn-primary" id="analyze-data" style="display: none;" onclick="window.location.href='../import-data.html#m=gemini'">
                    Analyze Data using Gemini
                </button>
            </div>
        </div>


        <div class="card">
            <h2 class="card-title">About Gemini AI Integration</h2>
            <p style="color: var(--text-secondary); margin-bottom: 16px;">
                The Gemini AI integration enhances MemberCommons with intelligent features like automated content generation, 
                data analysis, and smart recommendations for CRM activities.
            </p>
            
            <div class="info-grid">
                <div class="info-item">
                    <strong>API Key Requirements:</strong><br>
                    Valid Google Cloud project with Gemini API enabled
                </div>
                <div class="info-item">
                    <strong>Environment Variable:</strong><br>
                    GEMINI_API_KEY in your .env file
                </div>
                <div class="info-item">
                    <strong>API Endpoint:</strong><br>
                    generativelanguage.googleapis.com
                </div>
                <div class="info-item">
                    <strong>Test Method:</strong><br>
                    Lists available Gemini models
                </div>
            </div>

            <div class="warning-message">
                <strong>Security Note:</strong> Your API key is never displayed in full. Only the first 4 and last 4 characters are shown for verification.
            </div>
        </div>

        <div class="card">
            <h2 class="card-title">Connection Troubleshooting</h2>
            <p style="color: var(--text-secondary); margin-bottom: 16px;">
                If you're having issues connecting to the backend API or database, try these troubleshooting steps:
            </p>
            
            <div style="margin: 16px 0; padding: 16px; background: var(--bg-tertiary); border-radius: var(--radius-md);">
                <ol style="margin: 8px 0 0 20px; color: var(--text-secondary);">
                    <li>Make sure the Rust backend server is running: <code>cargo run serve</code></li>
                    <li>Verify the server is listening on port 8081</li>
                    <li>Check that your Azure PostgreSQL credentials are correct</li>
                    <li>Ensure your IP is allowed in Azure PostgreSQL firewall rules</li>
                    <li>Verify SSL certificate settings for Azure connection</li>
                </ol>
                <div style="margin-top: 12px; padding: 12px; background: var(--bg-secondary); border-radius: var(--radius-sm); border-left: 4px solid var(--accent-blue);">
                    <strong>Quick Fix:</strong> You can tell Claude Code CLI to restart the server:<br>
                    <code style="background: var(--bg-tertiary); padding: 2px 6px; border-radius: 3px;">"Go ahead and restart now"</code>
                </div>
            </div>
        </div>

        <div id="readmeDiv" class="card readme-content">
            <p style="color: var(--text-secondary); font-style: italic;">
                Loading README.md documentation...
            </p>
        </div>
    </div>

    <script src="../../js/common.js"></script>
    <script>
        const GEMINI_API_BASE = 'http://localhost:8081/api';
        let currentConfig = null;

        // DOM elements
        const apiStatus = document.getElementById('api-status');
        const configDisplay = document.getElementById('config-display');
        const testButton = document.getElementById('test-gemini');
        const testSpinner = document.getElementById('test-spinner');
        const testResult = document.getElementById('test-result');
        const testInstruction = document.getElementById('test-instruction');
        const configTitle = document.querySelector('#api-configuration-panel .card-title');
        const geminiKeyContainer = document.getElementById('gemini-key-container');
        
        // New Rust API panel elements
        const rustApiPanel = document.getElementById('rust-api-panel');
        const rustApiStatus = document.getElementById('rust-api-status');
        const rustApiTitle = document.getElementById('rust-api-title');
        const rustApiContent = document.getElementById('rust-api-content');
        const startWithClaudeBtn = document.getElementById('start-with-claude');
        const startWithoutClaudeBtn = document.getElementById('start-without-claude');
        
        // Web Server panel elements
        const webServerPanel = document.getElementById('web-server-panel');
        const webServerStatus = document.getElementById('web-server-status');
        const webServerTitle = document.getElementById('web-server-title');
        const webServerContent = document.getElementById('web-server-content');

        // Update Web Server panel status
        function updateWebServerPanel() {
            const currentHost = window.location.hostname;
            const currentPort = window.location.port;
            const isLocalhost8887 = currentHost === 'localhost' && currentPort === '8887';
            
            if (isLocalhost8887) {
                webServerStatus.className = 'status-indicator connected';
                webServerTitle.textContent = 'Web Server Running';
                const currentUrl = window.location.origin;
                webServerContent.innerHTML = `
                    <p style="color: var(--text-secondary); margin-bottom: 16px;">
                        Your local http server is <a href="${currentUrl}" target="_blank" style="color: var(--accent-blue); text-decoration: underline;">${currentUrl}</a>
                    </p>
                    <div class="actions">
                        <button class="btn btn-secondary" onclick="showWebserverCommand()">
                            Webserver Command
                        </button>
                    </div>
                `;
            } else {
                webServerStatus.className = 'status-indicator loading'; // grey dot for non-localhost
                webServerTitle.textContent = 'Local Web Server';
                webServerContent.innerHTML = `
                    <p style="color: var(--text-secondary); margin-bottom: 16px;">
                        Not running on localhost:8887. See setup instructions below.
                    </p>
                    <div class="actions">
                        <button class="btn btn-primary" onclick="showWebserverCommand()">
                            Webserver Command
                        </button>
                    </div>
                `;
            }
        }

        // Show webserver command instructions
        function showWebserverCommand() {
            webServerContent.innerHTML = `
                <div id="webserver-command-content">
                    <p style="color: var(--text-secondary); margin-bottom: 16px;">
                        Webserver setup instructions and commands:
                    </p>
                    <div id="claude-webserver-status"></div>
                    <button class="btn btn-secondary" onclick="updateWebServerPanel()" style="margin-top: 16px;">
                        ‚Üê Back to Status
                    </button>
                </div>
            `;
            
            // Load webserver status content
            setTimeout(() => {
                loadWebServerStatus("claude-webserver-status");
            }, 100);
        }

        // Show Rust API commands and README
        function showRustApiCommands() {
            rustApiContent.innerHTML = `
                <div id="rust-api-commands-content">
                    <p style="color: var(--text-secondary); margin-bottom: 16px;">
                        Rust API server commands and setup:
                    </p>
                    <div id="rust-api-readme-content" class="readme-content">
                        <p style="color: var(--text-secondary); font-style: italic;">
                            Loading README.md...
                        </p>
                    </div>
                    <div class="actions" style="margin-top: 16px;">
                        <button class="btn btn-secondary" onclick="updateRustApiPanel(true)">
                            ‚Üê Back to Status
                        </button>
                        <button class="btn btn-secondary" onclick="loadConfiguration()">
                            Reload Config Files
                        </button>
                        <button class="btn btn-secondary" onclick="stopServer()">
                            Stop Server
                        </button>
                    </div>
                </div>
            `;
            
            // Load code.md content
            setTimeout(() => {
                displayFile("code.md", "rust-api-readme-content", "_parent", null, false);
            }, 100);
        }

        // Parse .env file content
        function parseEnvFile(envText) {
            const config = {};
            const lines = envText.split('\n');
            
            for (const line of lines) {
                const trimmed = line.trim();
                if (trimmed && !trimmed.startsWith('#')) {
                    const [key, ...valueParts] = trimmed.split('=');
                    if (key && valueParts.length > 0) {
                        const value = valueParts.join('=');
                        config[key.trim()] = value.trim();
                    }
                }
            }
            
            // Apply same validation logic as backend
            config.gemini_api_key_present = !!(config.GEMINI_API_KEY && 
                config.GEMINI_API_KEY !== 'dummy_key' && 
                config.GEMINI_API_KEY !== 'get-key-at-aistudio.google.com');
                
            return config;
        }

        // Update Rust API panel status
        function updateRustApiPanel(isActive) {
            if (isActive) {
                rustApiStatus.className = 'status-indicator connected';
                rustApiTitle.textContent = 'Rust API Active';
                rustApiContent.innerHTML = `
                    <div style="color: var(--accent-green); margin-bottom: 16px;">
                        ‚úÖ Backend API is running and accessible
                    </div>
                    <p style="color: var(--text-secondary); margin-bottom: 16px;">
                        Full configuration and testing capabilities are available.
                    </p>
                    <div class="actions">
                        <button class="btn btn-secondary" onclick="showRustApiCommands()">
                            View Cmds
                        </button>
                        <button class="btn btn-secondary" onclick="loadConfiguration()">
                            Reload Config Files
                        </button>
                        <button class="btn btn-secondary" onclick="stopServer()">
                            Stop Server
                        </button>
                    </div>
                `;
            } else {
                rustApiStatus.className = 'status-indicator error';
                rustApiTitle.textContent = 'Rust API Inactive';
                rustApiContent.innerHTML = `
                    <div style="color: var(--accent-yellow); margin-bottom: 16px;">
                        ‚ö†Ô∏è Backend API unavailable - showing .env file data only
                    </div>
                    <p style="color: var(--text-secondary); margin-bottom: 16px;">
                        The Rust backend server needs to be started to access full configuration and testing capabilities.
                    </p>
                    <div class="actions">
                        <button class="btn btn-primary" id="start-with-claude-btn" onclick="startWithClaude()">
                            ü§ñ Use Claude (Recommended)
                        </button>
                        <button class="btn btn-secondary" id="start-without-claude-btn" onclick="startWithoutClaude()">
                            ‚öôÔ∏è Without Claude
                        </button>
                    </div>
                    <div style="margin-top: 12px; font-size: 12px; color: var(--text-secondary);">
                        Claude option will automatically start the server for you. Manual option shows commands to run yourself.
                    </div>
                `;
            }
        }

        // Start server with Claude
        async function startWithClaude() {
            const button = document.getElementById('start-with-claude-btn');
            if (button) {
                button.disabled = true;
                button.textContent = 'ü§ñ Starting...';
            }
            
            try {
                // Show instructions to user
                rustApiContent.innerHTML = `
                    <p style="color: var(--text-secondary); margin-bottom: 16px;">
                        ü§ñ If you already have Claude Code running, say: <strong>"Start  Server"</strong> or <strong>"Start the Rust API"</strong> or similar.
                    </p>
                    <button class="btn btn-secondary" onclick="updateRustApiPanel(false)" style="margin-top: 12px;">
                        ‚Üê Back to Options
                    </button>
                    
                    <div style="margin-top: 24px; padding: 24px; background: var(--bg-secondary); border-radius: var(--radius-lg); border: 1px solid var(--border-light);">
                        <div id="claude-code-content" class="readme-content">
                            <p style="color: var(--text-secondary); font-style: italic;">
                                Loading code.md...
                            </p>
                        </div>
                    </div>
                `;
                
                // Load content into the Claude instructions
                setTimeout(() => {
                    displayFile("code.md", "claude-code-content", "_parent", null, false);
                }, 100);
                
            } catch (error) {
                console.error('Error with Claude start option:', error);
                updateRustApiPanel(false);
            }
        }

        // Start server without Claude
        function startWithoutClaude() {
            rustApiContent.innerHTML = `
                <p style="color: var(--text-secondary); margin-bottom: 16px;">
                    ‚öôÔ∏è Alternative tools and manual setup options for running the server without Claude Code CLI.
                </p>
                <button class="btn btn-secondary" onclick="updateRustApiPanel(false)" style="margin-top: 12px;">
                    ‚Üê Back to Options
                </button>
                
                <div style="margin-top: 24px; padding: 24px; background: var(--bg-secondary); border-radius: var(--radius-lg); border: 1px solid var(--border-light);">
                    <div id="other-tools-content" class="readme-content">
                        <p style="color: var(--text-secondary); font-style: italic;">
                            Loading other.md...
                        </p>
                    </div>
                </div>
            `;
            
            // Load other.md content
            setTimeout(() => {
                displayFile("other.md", "other-tools-content", "_parent", null, false);
            }, 100);
        }

        // Load README content for setup instructions
        function loadWebServerStatus(containerId) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            // Always show README content for local setup (web server status is now in its own panel)
            const readmeId = `${containerId}-readme`;
            container.innerHTML = `
                <h3 style="margin-bottom: 16px; color: var(--text-primary);">üõ°Ô∏è Run Webserver Locally</h3>
                <div id="${readmeId}" class="readme-content">
                    <p style="color: var(--text-secondary); font-style: italic;">
                        Loading README.md...
                    </p>
                </div>
            `;
            
            // Load README content
            setTimeout(() => {
                displayFile("../README.md", readmeId, "_parent", null, false);
            }, 50);
        }

        // Show connection help (now displayed as a separate card below)
        function showConnectionHelp() {
            // Connection troubleshooting is now shown as a separate card on the page
            // No longer need to add inline help since it's always visible
        }

        // Create .env file from .env.example
        async function createEnvFromExample() {
            try {
                // First, try to read .env.example
                const exampleResponse = await fetch('../../.env.example');
                if (!exampleResponse.ok) {
                    throw new Error('.env.example file not found');
                }
                
                const exampleContent = await exampleResponse.text();
                
                // Try to create .env file via backend
                const createResponse = await fetch(`${GEMINI_API_BASE}/config/create-env`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        content: exampleContent
                    })
                });
                
                if (createResponse.ok) {
                    // Successfully created .env file
                    configDisplay.innerHTML = `
                        <div style="color: var(--accent-green); margin-bottom: 16px;">
                            ‚úÖ Created .env file from .env.example template
                        </div>
                        <strong>Configuration Source:</strong> .env file (newly created)<br>
                        <strong>Gemini API Key:</strong> <span style="color: var(--accent-red);">Needs to be configured</span><br>
                    `;
                    
                    // Show the Gemini key input field
                    geminiKeyContainer.style.display = 'block';
                    geminiKeyContainer.innerHTML = `
<div style="margin: 16px 0; padding: 16px; background: var(--bg-tertiary); border-radius: var(--radius-md); border: 1px solid var(--border-light);">
    <strong>Enter Your Gemini API Key:</strong>
    <div style="margin-top: 8px; display: flex; gap: 8px; align-items: center;">
        <input type="text" id="gemini-key-input" placeholder="AIzaSy..." 
               style="flex: 1; padding: 8px 12px; border: 1px solid var(--border-medium); border-radius: var(--radius-sm); font-family: monospace;">
        <button id="save-key-btn" class="btn btn-primary" onclick="saveGeminiKey()">Save</button>
    </div>
    <div style="margin-top: 8px; font-size: 12px; color: var(--text-secondary);">
        Get your API key from <a href="https://aistudio.google.com" target="_blank" style="color: var(--accent-blue);">Google AI Studio</a>
    </div>
</div>`;
                    
                    // Add enter key listener
                    setTimeout(() => {
                        const keyInput = document.getElementById('gemini-key-input');
                        if (keyInput) {
                            keyInput.addEventListener('keypress', function(e) {
                                if (e.key === 'Enter') {
                                    saveGeminiKey();
                                }
                            });
                        }
                    }, 100);
                    
                } else {
                    throw new Error('Failed to create .env file via backend');
                }
                
            } catch (error) {
                // Failed to create .env file
                configDisplay.innerHTML = `
                    <div style="color: var(--accent-red); margin-bottom: 16px;">
                        ‚ùå Could not create .env file automatically
                    </div>
                    <strong>Issue:</strong> ${error.message}<br><br>
                    <strong>Manual Setup Required:</strong><br>
                    1. Copy .env.example to .env<br>
                    2. Edit the GEMINI_API_KEY value<br>
                    3. Start the backend server<br>
                    Or run locally using the commands on our <a href="../admin" style="color: var(--accent-blue); text-decoration: underline;">Admin Page</a>
                `;
                
                // Show connection help for troubleshooting
                showConnectionHelp();
                
                console.error('Failed to create .env from example:', error);
            }
        }

        // Load configuration on page load
        async function loadConfiguration() {
            // Declare variables at function scope so they're available in catch block
            let envFileData = {};
            let envFileExists = false;
            
            try {
                apiStatus.className = 'status-indicator loading';
                configDisplay.textContent = 'Loading configuration files (.env and settings.js)...';
                
                // Load .env file directly from frontend first
                try {
                    const envFileResponse = await fetch('../../.env');
                    if (envFileResponse.ok) {
                        envFileExists = true;
                        const envFileText = await envFileResponse.text();
                        envFileData = parseEnvFile(envFileText);
                        console.log('Loaded .env file directly');
                    } else if (envFileResponse.status === 404) {
                        console.log('.env file not found');
                        envFileExists = false;
                    }
                } catch (envFileError) {
                    console.log('.env file loading failed:', envFileError.message);
                    envFileExists = false;
                }
                
                // Try to load .env configuration from backend
                let envData = {};
                try {
                    const envResponse = await fetch(`${GEMINI_API_BASE}/config/env`);
                    if (envResponse.ok) {
                        envData = await envResponse.json();
                    } else {
                        throw new Error(`Backend returned ${envResponse.status}`);
                    }
                } catch (backendError) {
                    console.log('Backend API unavailable:', backendError.message);
                    // Continue with .env file data only
                    throw new Error('Backend API unavailable');
                }
                
                // Load settings.js configuration from frontend (if available)
                let settingsData = {};
                try {
                    // Try to load config/settings.js if it exists as a simple JSON file
                    const settingsResponse = await fetch('../../config/settings.js');
                    if (settingsResponse.ok) {
                        settingsData = await settingsResponse.json();
                        console.log('Loaded settings.js configuration');
                    } else {
                        console.log('settings.js not found (this is optional)');
                    }
                } catch (settingsError) {
                    console.log('settings.js loading failed or not available (this is optional):', settingsError.message);
                }
                
                // Merge configurations (direct .env file takes highest precedence)
                const mergedConfig = {
                    ...settingsData,
                    ...envData,
                    ...envFileData,
                    source: 'merged (.env file + backend + settings.js)'
                };
                
                // Use .env file data for Gemini key presence if available
                if (envFileData.GEMINI_API_KEY !== undefined) {
                    mergedConfig.gemini_api_key_present = envFileData.gemini_api_key_present;
                }
                
                currentConfig = mergedConfig;
                displayConfiguration(mergedConfig);
                
                // Update Rust API panel to show active state
                updateRustApiPanel(true);
                
                // Update title based on configuration status
                const hasIssues = !mergedConfig.gemini_api_key_present || !mergedConfig.database;
                const statusClass = hasIssues ? 'error' : 'connected';
                const titleText = !mergedConfig.gemini_api_key_present ? 'Gemini API Key Needed' : 
                                 hasIssues ? 'API Configuration Issue' : 'API Configuration Good';
                configTitle.innerHTML = `
                    <span class="status-indicator ${statusClass}" id="api-status"></span>
                    ${titleText}
                `;
                
                // Reset UI state when reloading configuration
                testButton.style.display = 'inline-block';
                testButton.className = 'btn btn-primary';
                testButton.textContent = 'Test Gemini API';
                testButton.disabled = !mergedConfig.gemini_api_key_present;
                document.getElementById('analyze-data').style.display = 'none';
                
                // Hide instruction when backend is available
                testInstruction.style.display = 'none';
                
                // Clear previous test results
                testResult.innerHTML = '';
                
                // Restart server functionality is now handled in the Rust API panel
                
            } catch (error) {
                // Update Rust API panel to show inactive state
                updateRustApiPanel(false);
                
                // Even if backend is down, we can still use .env file data if available
                if (envFileExists && envFileData.GEMINI_API_KEY) {
                    // We have .env file data, use it for configuration
                    const hasValidKey = envFileData.gemini_api_key_present;
                    const statusClass = hasValidKey ? 'connected' : 'error';
                    const titleText = hasValidKey ? 'Gemini API Key Present' : 'Gemini API Key Needed';
                    
                    apiStatus.className = `status-indicator ${statusClass}`;
                    configTitle.innerHTML = `
                        <span class="status-indicator ${statusClass}" id="api-status"></span>
                        ${titleText}
                    `;
                    
                    // Show limited configuration from .env file
                    displayConfiguration({
                        ...envFileData,
                        source: '.env file (backend unavailable)',
                        database: null // We don't have database info without backend
                    });
                    
                    // Show instruction when backend is unavailable
                    testInstruction.style.display = 'block';
                    
                    // Backend status is now handled by the rust-api-panel
                    
                    // Show connection help for troubleshooting
                    showConnectionHelp();
                    
                } else if (envFileExists) {
                    // .env file exists but no valid key
                    apiStatus.className = 'status-indicator error';
                    configTitle.innerHTML = `
                        <span class="status-indicator error" id="api-status"></span>
                        Gemini API Key Needed
                    `;
                    
                    configDisplay.innerHTML = `
                        <strong>Configuration Source:</strong> .env file (backend unavailable)<br>
                        <strong>Gemini API Key:</strong> <span style="color: var(--accent-red);">Not configured or invalid</span><br>
                    `;
                    
                    // Show instruction when backend is unavailable
                    testInstruction.style.display = 'block';
                    
                    // Show connection help for troubleshooting
                    showConnectionHelp();
                    
                } else {
                    // No .env file found - try to create it from .env.example
                    apiStatus.className = 'status-indicator error';
                    configTitle.innerHTML = `
                        <span class="status-indicator error" id="api-status"></span>
                        Gemini API Key Needed
                    `;
                    
                    // Show instruction when backend is unavailable
                    testInstruction.style.display = 'block';
                    
                    // Try to create .env from .env.example
                    await createEnvFromExample();
                }
                
                console.error('Failed to load configuration:', error);
            }
        }

        // Display configuration information
        function displayConfiguration(config) {
            const status = config.gemini_api_key_present ? 'Present' : 'Not configured';
            const statusColor = config.gemini_api_key_present ? 'var(--accent-green)' : 'var(--accent-red)';
            
            apiStatus.className = `status-indicator ${config.gemini_api_key_present ? 'connected' : 'error'}`;
            
            const configSource = config.source || '.env file';
            
            // Show/hide API key input field based on key presence
            if (!config.gemini_api_key_present) {
                geminiKeyContainer.style.display = 'block';
                geminiKeyContainer.innerHTML = `
<div style="margin: 16px 0; padding: 16px; background: var(--bg-tertiary); border-radius: var(--radius-md); border: 1px solid var(--border-light);">
    <strong>Enter Your Gemini API Key:</strong>
    <div style="margin-top: 8px; display: flex; gap: 8px; align-items: center;">
        <input type="text" id="gemini-key-input" placeholder="AIzaSy..." 
               style="flex: 1; padding: 8px 12px; border: 1px solid var(--border-medium); border-radius: var(--radius-sm); font-family: monospace;">
        <button id="save-key-btn" class="btn btn-primary" onclick="saveGeminiKey()">Save</button>
    </div>
    <div style="margin-top: 8px; font-size: 12px; color: var(--text-secondary);">
        Get your API key from <a href="https://aistudio.google.com" target="_blank" style="color: var(--accent-blue);">Google AI Studio</a>
    </div>
</div>`;
                
                // Add enter key listener to input field
                setTimeout(() => {
                    const keyInput = document.getElementById('gemini-key-input');
                    if (keyInput) {
                        keyInput.addEventListener('keypress', function(e) {
                            if (e.key === 'Enter') {
                                saveGeminiKey();
                            }
                        });
                    }
                }, 100);
            } else {
                geminiKeyContainer.style.display = 'none';
                geminiKeyContainer.innerHTML = '';
            }

            // Display regular configuration info
            configDisplay.innerHTML = `
<strong>Configuration Source:</strong> ${configSource}
<strong>Gemini API Key:</strong> <span style="color: ${statusColor};">${status}</span>
<strong>Database:</strong> ${config.database ? config.database.database + ' @ ' + config.database.server : 'Not configured'}
<strong>SSL:</strong> ${config.database ? (config.database.ssl ? 'Enabled' : 'Disabled') : 'N/A'}
<strong>Environment:</strong> ${config.gemini_api_key_present ? 'Production' : 'Development'}`;
        }

        // Save Gemini API key
        async function saveGeminiKey() {
            const keyInput = document.getElementById('gemini-key-input');
            const saveBtn = document.getElementById('save-key-btn');
            
            if (!keyInput || !keyInput.value.trim()) {
                alert('Please enter a valid API key');
                return;
            }
            
            const apiKey = keyInput.value.trim();
            
            // Basic validation - Gemini keys should start with AIza and be around 39 chars
            if (!apiKey.startsWith('AIza') || apiKey.length < 35) {
                alert('API key format appears invalid. Gemini keys should start with "AIza" and be around 39 characters long.');
                return;
            }
            
            try {
                saveBtn.disabled = true;
                saveBtn.textContent = 'Saving...';
                
                // Check if .env file exists
                let envExists = false;
                try {
                    const envCheck = await fetch('../../.env');
                    envExists = envCheck.ok;
                } catch (e) {
                    envExists = false;
                }
                
                if (!envExists) {
                    // Create .env from .env.example first
                    try {
                        const exampleResponse = await fetch('../../.env.example');
                        if (!exampleResponse.ok) {
                            throw new Error('.env.example file not found');
                        }
                        
                        const exampleContent = await exampleResponse.text();
                        
                        // Replace the placeholder Gemini key with the real one
                        const updatedContent = exampleContent.replace(
                            /GEMINI_API_KEY=.*/,
                            `GEMINI_API_KEY=${apiKey}`
                        );
                        
                        // Create .env file with the updated content
                        const createResponse = await fetch(`${GEMINI_API_BASE}/config/create-env`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                content: updatedContent
                            })
                        });
                        
                        if (!createResponse.ok) {
                            throw new Error('Failed to create .env file');
                        }
                        
                        // Hide the input field and show success message
                        geminiKeyContainer.style.display = 'none';
                        
                        // Update the configuration display
                        configDisplay.innerHTML = `
                            <div style="color: var(--accent-green); margin-bottom: 16px; font-weight: bold;">
                                ‚úÖ Successfully created .env file from template and added your Gemini API key!
                            </div>
                            <strong>Configuration Source:</strong> .env file (newly created)<br>
                            <strong>Gemini API Key:</strong> <span style="color: var(--accent-green);">Configured and ready</span><br>
                            <strong>Status:</strong> <span style="color: var(--accent-green);">Configuration complete</span>
                        `;
                        
                        // Update the title to show success
                        configTitle.innerHTML = `
                            <span class="status-indicator connected" id="api-status"></span>
                            API Configuration Good
                        `;
                        
                        return; // Exit early since we've handled everything
                        
                    } catch (error) {
                        alert('Failed to create .env file: ' + error.message);
                        return;
                    }
                } else {
                    // .env file exists, just update the key
                    const response = await fetch(`${GEMINI_API_BASE}/config/save-env`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            GEMINI_API_KEY: apiKey
                        })
                    });
                    
                    if (response.ok) {
                        // Hide the input field and reload configuration
                        geminiKeyContainer.style.display = 'none';
                        await loadConfiguration();
                        
                        // Show success message
                        configDisplay.innerHTML += `
                            <br><div style="color: var(--accent-green); margin-top: 16px; font-weight: bold;">
                                ‚úÖ Gemini API key updated successfully!
                            </div>
                        `;
                    } else {
                        const error = await response.json();
                        alert('Failed to save API key: ' + (error.error || 'Unknown error'));
                    }
                }
                
            } catch (error) {
                alert('Error saving API key: ' + error.message);
            } finally {
                saveBtn.disabled = false;
                saveBtn.textContent = 'Save';
            }
        }

        // Stop server function
        async function stopServer() {
            if (!confirm('This will stop the Rust API server. Continue?')) {
                return;
            }
            
            try {
                // Get the stop button from the current context
                const stopBtn = document.activeElement;
                if (stopBtn) {
                    stopBtn.disabled = true;
                    stopBtn.textContent = 'Stopping...';
                }
                
                // Try to call the restart endpoint to stop the server
                try {
                    const response = await fetch(`${GEMINI_API_BASE}/admin/restart`, {
                        method: 'POST'
                    });
                } catch (e) {
                    // Server likely stopped, which is expected
                }
                
                // Wait a moment for server to stop
                setTimeout(() => {
                    // Refresh the page to update the UI
                    window.location.reload();
                }, 2000);
                
            } catch (error) {
                console.error('Error stopping server:', error);
                // Still refresh the page to update the UI
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            }
        }

        // Restart server function (kept for compatibility)
        async function restartServer() {
            // Redirect to stop server function
            await stopServer();
        }

        // Test Gemini API key
        async function testGeminiAPI() {
            try {
                testButton.disabled = true;
                testSpinner.style.display = 'inline-block';
                testResult.innerHTML = '';
                
                const response = await fetch(`${GEMINI_API_BASE}/config/gemini`);
                const data = await response.json();
                
                displayTestResult(data);
                
            } catch (error) {
                displayTestResult({
                    success: false,
                    message: 'Failed to connect to API server',
                    error: error.message,
                    api_key_present: false
                });
            } finally {
                testButton.disabled = false;
                testSpinner.style.display = 'none';
            }
        }

        // Display test results
        function displayTestResult(result) {
            const resultClass = result.success ? 'success-message' : 'error-message';
            const icon = result.success ? '‚úÖ' : '‚ùå';
            
            let html = `
                <div class="${resultClass}">
                    <h4>${icon} ${result.message}</h4>
                    <div class="details">
API Key Present: ${result.api_key_present ? 'Yes' : 'No'}`;
            
            if (result.api_key_preview) {
                html += `\nAPI Key Preview: ${result.api_key_preview}`;
            }
            
            if (result.error) {
                html += `\nError Details: ${result.error}`;
            }
            
            if (result.success) {
                html += `\nStatus: API key is valid and working
Test: Successfully connected to Gemini API
Ready: AI features are available`;
                
                // Hide test button and show analyze data button
                testButton.style.display = 'none';
                document.getElementById('analyze-data').style.display = 'inline-block';
            }
            
            html += `
                    </div>
                </div>
            `;
            
            testResult.innerHTML = html;
        }

        // Event listeners
        testButton.addEventListener('click', testGeminiAPI);

        // OS Detection and CLI functionality
        function detectAndSetOS() {
            const osSelect = document.getElementById('os');
            const osInfo = document.getElementById('os-info');
            const claudeCodeCli = document.getElementById('claude-code-cli');
            const geminiCli = document.getElementById('gemini-cli');
            const cliCommands = document.getElementById('cli-commands');
            const claudeCodeCommands = document.getElementById('claude-code-commands');
            const geminiCommands = document.getElementById('gemini-commands');
            const repoNameSpan = document.getElementById('repo-name');
            
            const userAgent = navigator.userAgent;
            const platform = navigator.platform;
            
            // Detect repo folder name from current URL path
            let repoName = 'team'; // Default fallback
            const currentPath = window.location.pathname;
            const pathSegments = currentPath.split('/').filter(segment => segment);
            
            // Look for the segment before 'admin/server'
            const adminIndex = pathSegments.findIndex(segment => segment === 'admin');
            if (adminIndex > 0) {
                // There's a folder before 'admin'
                repoName = pathSegments[adminIndex - 1];
            }
            
            // Update the repo name in the instructions
            repoNameSpan.textContent = repoName;
            
            let detectedOS = '';
            let osDetails = '';
            
            // Detect OS based on user agent and platform
            if (userAgent.includes('Mac') || platform.includes('Mac')) {
                detectedOS = 'Mac';
                osDetails = `Detected: macOS (${platform})`;
            } else if (userAgent.includes('Windows') || platform.includes('Win')) {
                detectedOS = 'PC';
                osDetails = `Detected: Windows (${platform})`;
            } else if (userAgent.includes('Linux') || platform.includes('Linux')) {
                detectedOS = 'Linux';
                osDetails = `Detected: Linux (${platform})`;
            } else {
                detectedOS = 'Other';
                osDetails = `Detected: Unknown OS (${platform})`;
            }
            
            // Auto-select the detected OS
            osSelect.value = detectedOS;
            osInfo.textContent = osDetails;
            
            // Function to detect CLI installations
            async function detectCLIInstallations() {
                // Try to detect Claude Code CLI
                try {
                    // Check if we can detect Claude Code CLI presence
                    // This is a heuristic - we'll check for common indicators
                    const claudeCodeDetected = await checkClaudeCodeCLI();
                    if (claudeCodeDetected) {
                        claudeCodeCli.checked = true;
                        localStorage.setItem('claude-code-cli-installed', 'true');
                    }
                } catch (e) {
                    // Detection failed, continue
                }
                
                // Try to detect Gemini CLI
                try {
                    // Check if we can detect Gemini CLI presence
                    const geminiDetected = await checkGeminiCLI();
                    if (geminiDetected) {
                        geminiCli.checked = true;
                        localStorage.setItem('gemini-cli-installed', 'true');
                    }
                } catch (e) {
                    // Detection failed, continue
                }
            }
            
            // Helper function to check Claude Code CLI
            async function checkClaudeCodeCLI() {
                // Multiple heuristics to detect Claude Code CLI presence
                const hasClaudeHistory = localStorage.getItem('claude-code-usage') === 'true';
                const isDevelopmentEnv = window.location.hostname === 'localhost' || 
                                       window.location.hostname === '127.0.0.1';
                
                // Check if we're currently in a Claude Code session (heuristic)
                const isClaudeCodeSession = window.location.search.includes('claude') || 
                                          document.referrer.includes('claude') ||
                                          localStorage.getItem('claude-session') === 'true';
                
                // Check for development environment indicators
                const hasDevIndicators = window.location.port === '8081' || // Rust API port
                                        window.location.port === '8887' || // Webroot container
                                        window.location.port === '8888';   // Direct repo serving
                
                // Auto-detect if we're in a development environment with Claude indicators
                if (isDevelopmentEnv && hasDevIndicators) {
                    // Set usage flag for future detection
                    localStorage.setItem('claude-code-usage', 'true');
                    return true;
                }
                
                return hasClaudeHistory && isDevelopmentEnv;
            }
            
            // Helper function to check Gemini CLI
            async function checkGeminiCLI() {
                // Check for Gemini-related indicators
                const hasGeminiHistory = localStorage.getItem('gemini-cli-usage') === 'true';
                const isDevelopmentEnv = window.location.hostname === 'localhost' || 
                                       window.location.hostname === '127.0.0.1';
                
                // Check if Gemini API is configured (from the current page's config)
                const hasGeminiConfig = currentConfig && currentConfig.gemini_api_key_present;
                
                // If Gemini API is configured, it's likely they have or need the CLI
                if (hasGeminiConfig && isDevelopmentEnv) {
                    localStorage.setItem('gemini-cli-usage', 'true');
                    return true;
                }
                
                return hasGeminiHistory && isDevelopmentEnv;
            }
            
            // Load saved CLI selections from localStorage (fallback if detection fails)
            const savedClaudeCode = localStorage.getItem('claude-code-cli-installed');
            const savedGemini = localStorage.getItem('gemini-cli-installed');
            
            if (savedClaudeCode === 'true') {
                claudeCodeCli.checked = true;
            }
            if (savedGemini === 'true') {
                geminiCli.checked = true;
            }
            
            // Attempt to detect CLI installations
            detectCLIInstallations().then(() => {
                // Update commands after detection
                updateCliCommands();
            });
            
            // Function to update CLI commands display
            function updateCliCommands() {
                const selectedOS = osSelect.value;
                const claudeCodeChecked = claudeCodeCli.checked;
                const geminiChecked = geminiCli.checked;
                
                // Show/hide the commands container
                if (claudeCodeChecked || geminiChecked) {
                    cliCommands.style.display = 'block';
                } else {
                    cliCommands.style.display = 'none';
                    return;
                }
                
                // Update Claude Code CLI commands based on OS
                if (claudeCodeChecked) {
                    claudeCodeCommands.style.display = 'block';
                    const claudeCodeCommandsContent = claudeCodeCommands.querySelector('pre code');
                    
                    if (selectedOS === 'Mac' || selectedOS === 'Linux') {
                        claudeCodeCommandsContent.textContent = `python3 -m venv env
source env/bin/activate
npx @anthropic-ai/claude-code`;
                    } else if (selectedOS === 'PC') {
                        claudeCodeCommandsContent.textContent = `python -m venv env
env\\Scripts\\activate
npx @anthropic-ai/claude-code`;
                    } else {
                        claudeCodeCommandsContent.textContent = `# For Unix/Linux/Mac:
python3 -m venv env
source env/bin/activate
npx @anthropic-ai/claude-code

# For Windows:
python -m venv env
env\\Scripts\\activate
npx @anthropic-ai/claude-code`;
                    }
                } else {
                    claudeCodeCommands.style.display = 'none';
                }
                
                // Update Gemini CLI commands (same for all OS)
                if (geminiChecked) {
                    geminiCommands.style.display = 'block';
                } else {
                    geminiCommands.style.display = 'none';
                }
            }
            
            // Add OS select change event listener
            osSelect.addEventListener('change', function() {
                const selectedOS = this.value;
                if (selectedOS) {
                    osInfo.textContent = `Selected: ${selectedOS}`;
                } else {
                    osInfo.textContent = osDetails; // Show detection again if blank is selected
                }
                updateCliCommands();
            });
            
            // Add checkbox event listeners
            claudeCodeCli.addEventListener('change', function() {
                localStorage.setItem('claude-code-cli-installed', this.checked);
                updateCliCommands();
            });
            
            geminiCli.addEventListener('change', function() {
                localStorage.setItem('gemini-cli-installed', this.checked);
                updateCliCommands();
            });
            
            // Initial update of CLI commands
            updateCliCommands();
        }

        // Initialize page
        updateWebServerPanel(); // Check web server status
        updateRustApiPanel(false); // Start with inactive state
        loadConfiguration();
        detectAndSetOS(); // Auto-detect and set OS
        
        // Load README without logging to keep the interface clean
        displayFile("README.md", "readmeDiv", "_parent", null, false);
    </script>
    
    <!-- Feather Icons -->
    <script src="https://unpkg.com/feather-icons"></script>
    <script>
        // Initialize Feather Icons
        feather.replace();
    </script>
</body>
</html>